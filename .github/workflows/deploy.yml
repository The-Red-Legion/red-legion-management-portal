name: Deploy Red Legion Website

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual deployment

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to GCP Web Server
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Build frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Create deployment package
      run: |
        # Create deployment directory structure
        mkdir -p deployment-package/backend
        mkdir -p deployment-package/frontend/dist
        mkdir -p deployment-package/static
        
        # Copy backend files
        cp -r backend/* deployment-package/backend/
        
        # Copy built frontend
        cp -r frontend/dist/* deployment-package/frontend/dist/
        
        # Copy static files
        cp -r static/* deployment-package/static/ 2>/dev/null || true
        
        # Copy requirements and other config files
        cp requirements.txt deployment-package/
        cp .env.example deployment-package/

    - name: Deploy with GCloud
      run: |
        # Copy deployment package to VM
        gcloud compute scp --recurse deployment-package/* ubuntu@arccorp-web-server:/tmp/deployment/ --zone us-central1-a
        
        # Deploy using gcloud ssh
        gcloud compute ssh ubuntu@arccorp-web-server --zone us-central1-a --command "
          # Stop existing service
          sudo systemctl stop red-legion-website-backend || true
          
          # Backup and replace application files
          sudo rm -rf /opt/red-legion-website/backup || true
          sudo mkdir -p /opt/red-legion-website/backup || true
          sudo cp -r /opt/red-legion-website/* /opt/red-legion-website/backup/ 2>/dev/null || true
          sudo find /opt/red-legion-website -mindepth 1 -not -path '*/backup*' -delete || true
          sudo cp -r /tmp/deployment/* /opt/red-legion-website/
          sudo chown -R ubuntu:ubuntu /opt/red-legion-website
          
          # Create virtual environment and install requirements
          cd /opt/red-legion-website
          sudo -u ubuntu python3 -m venv venv
          sudo -u ubuntu ./venv/bin/pip install -r requirements.txt
          
          # Create environment file
          sudo tee /opt/red-legion-website/.env > /dev/null <<EOF
        DATABASE_URL='${{ secrets.DATABASE_URL }}'
        BOT_API_URL='${{ secrets.BOT_API_INTERNAL_URL }}'
        DOMAIN_NAME='${{ secrets.DOMAIN_NAME }}'
        DISCORD_CLIENT_ID='${{ secrets.DISCORD_CLIENT_ID }}'
        DISCORD_CLIENT_SECRET='${{ secrets.DISCORD_CLIENT_SECRET }}'
        DISCORD_REDIRECT_URI='${{ secrets.DISCORD_REDIRECT_URI }}'
        EOF
        
          # Fix permissions
          sudo chown ubuntu:ubuntu /opt/red-legion-website/.env
          sudo chmod 640 /opt/red-legion-website/.env
          
          # Start the service
          sudo systemctl start red-legion-website-backend
          sudo systemctl enable red-legion-website-backend
          
          # Wait for service to start and check status
          sleep 5
          sudo systemctl status red-legion-website-backend
        "

    - name: Verify deployment
      run: |
        echo "Deployment completed successfully!"
        echo "Web server should be accessible at: http://34.28.1.154:8000"
        echo "Domain: ${{ secrets.DOMAIN_NAME }}"